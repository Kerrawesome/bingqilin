<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingqilin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="https://em-content.zobj.net/source/google/439/soft-ice-cream_1f366.png">
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --md-sys-color-primary: #8c520c;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #ffdcb8;
            --md-sys-color-on-primary-container: #2e1500;
            --md-sys-color-secondary: #745a43;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #ffdcb8;
            --md-sys-color-on-secondary-container: #2a1807;
            --md-sys-color-tertiary: #5c6237;
            --md-sys-color-on-tertiary: #ffffff;
            --md-sys-color-tertiary-container: #e0e7b0;
            --md-sys-color-on-tertiary-container: #191e00;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-background: #fef7f0;
            --md-sys-color-on-background: #201a14;
            --md-sys-color-surface: #fffbff;
            --md-sys-color-on-surface: #201a14;
            --md-sys-color-surface-variant: #f2e0d0;
            --md-sys-color-on-surface-variant: #51443a;
            --md-sys-color-surface-container-high: #ede6de; /* For hover states */
            --md-sys-color-outline: #837468;
            --md-sys-color-shadow: #000000;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
        }
        
        /* Hide scrollbar */
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }


        /* Orientation-Aware Video Player */
        #video-iframe {
            border: none;
            background-color: #000;
            width: 100%;
            height: 100%;
        }
        
        .material-icons {
            transition: transform 0.3s ease;
        }
        .expand-summary-btn[aria-expanded="true"] .material-icons {
            transform: rotate(180deg);
        }

    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-[var(--md-sys-color-surface)] p-4 flex justify-between items-center sticky top-0 z-40 shadow-md">
        <h1 class="text-3xl text-[var(--md-sys-color-primary)]">Bing Qilin</h1>
        <button id="settings-button" class="text-[var(--md-sys-color-on-surface-variant)] hover:text-[var(--md-sys-color-primary)] transition-colors duration-300 p-2 rounded-full hover:bg-[var(--md-sys-color-primary-container)]">
            <span class="material-icons">settings</span>
        </button>
    </header>

    <!-- Main Content -->
    <main class="p-4 md:p-6">
        <div id="search-container" class="mb-8">
             <div class="relative">
                <span class="material-icons absolute left-4 top-1/2 -translate-y-1/2 text-[var(--md-sys-color-on-surface-variant)]">search</span>
                <input type="text" id="search-bar" class="w-full bg-[var(--md-sys-color-surface-variant)] text-[var(--md-sys-color-on-surface-variant)] rounded-full pl-12 pr-6 py-3 text-md border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-[var(--md-sys-color-primary)]" placeholder="Search movies & TV shows...">
            </div>
        </div>
        
        <div id="navigation-controls" class="mb-4"></div>

        <!-- Content Views -->
        <div id="search-results" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-8 gap-x-4 gap-y-8"></div>
        <div id="seasons-container" class="hidden">
            <h2 id="seasons-title" class="text-3xl font-bold mb-4"></h2>
            <div id="seasons-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-8 gap-x-4 gap-y-8"></div>
        </div>
        <div id="episodes-container" class="hidden mt-8">
            <h3 id="episodes-title" class="text-2xl font-medium mb-4"></h3>
            <div id="episodes-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
        </div>
    </main>

    <!-- IFrame Modal Overlay -->
    <div id="iframe-modal" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center">
        <button id="close-iframe-button" class="material-icons absolute top-2 right-2 text-white/70 hover:text-white transition-colors text-4xl z-10">close</button>
        <iframe id="video-iframe" allowfullscreen referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-[var(--md-sys-color-surface)] text-[var(--md-sys-color-on-surface)] p-6 rounded-3xl shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-medium mb-6">API Settings</h2>
            
            <div class="mb-4">
                <label for="custom-api-movie-url" class="block mb-2 font-medium">Custom Movie URL:</label>
                <input type="text" id="custom-api-movie-url" class="w-full bg-[var(--md-sys-color-surface-variant)] text-[var(--md-sys-color-on-surface-variant)] rounded-lg px-4 py-2 border border-transparent focus:outline-none focus:ring-2 focus:ring-[var(--md-sys-color-primary)]" placeholder="https://.../movie/{tmdb}">
            </div>
            
            <div class="mb-4">
                <label for="custom-api-tv-url" class="block mb-2 font-medium">Custom TV URL:</label>
                <input type="text" id="custom-api-tv-url" class="w-full bg-[var(--md-sys-color-surface-variant)] text-[var(--md-sys-color-on-surface-variant)] rounded-lg px-4 py-2 border border-transparent focus:outline-none focus:ring-2 focus:ring-[var(--md-sys-color-primary)]" placeholder="https://.../tv/{tmdb}/{season}/{episode}">
            </div>

            <div class="mb-4">
                <p class="mb-3 font-medium">Presets:</p>
                <div id="preset-buttons-container" class="flex flex-wrap gap-2"></div>
            </div>
            
            <div class="flex justify-end space-x-2 mt-6">
                <button id="close-settings" class="px-6 py-2 rounded-full hover:bg-[var(--md-sys-color-secondary-container)] transition-colors text-[var(--md-sys-color-on-secondary-container)] font-medium">Close</button>
                <button id="save-settings" class="bg-[var(--md-sys-color-primary)] text-[var(--md-sys-color-on-primary)] font-bold py-2 px-6 rounded-full hover:opacity-90 transition-opacity">Save</button>
            </div>
        </div>
    </div>

    <script>
        const TMDB_API_KEY = "eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI0OTNiNWI3ODhlM2U0NDM4Y2Y2ZmY0ODI3NTJjN2Q2MSIsIm5iZiI6MTcxOTMxMjU2OC41NTY3MDEsInN1YiI6IjY2N2E5ZTczOTdkMDQ3YWNlNTNiNWU2MiIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.TRZDf_GmWas5rFhq-6wzT7RUJOCxvCUFf6hT-Jd9iIM";
        
        // DOM Elements
        const searchContainer = document.getElementById('search-container');
        const searchBar = document.getElementById('search-bar');
        const searchResults = document.getElementById('search-results');
        const iframeModal = document.getElementById('iframe-modal');
        const videoIframe = document.getElementById('video-iframe');
        const closeIframeButton = document.getElementById('close-iframe-button');
        const seasonsContainer = document.getElementById('seasons-container');
        const seasonsTitle = document.getElementById('seasons-title');
        const seasonsGrid = document.getElementById('seasons-grid');
        const episodesContainer = document.getElementById('episodes-container');
        const episodesTitle = document.getElementById('episodes-title');
        const episodesList = document.getElementById('episodes-list');
        const navigationControls = document.getElementById('navigation-controls');
        // Settings Modal Elements
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettings = document.getElementById('close-settings');
        const saveSettings = document.getElementById('save-settings');
        const customApiMovieUrlInput = document.getElementById('custom-api-movie-url');
        const customApiTvUrlInput = document.getElementById('custom-api-tv-url');
        const presetButtonsContainer = document.getElementById('preset-buttons-container');

        // App State
        let lastSearchResultsData = [];
        let currentTvShowData = {};
        let API_PRESETS = [];
        
        // Settings State
        let currentApiUrls = {
            movie: localStorage.getItem('customApiMovieUrl') || '',
            tv: localStorage.getItem('customApiTvUrl') || ''
        };
        
        const tmdbOptions = {
            method: 'GET',
            headers: {
                accept: 'application/json',
                Authorization: `Bearer ${TMDB_API_KEY}`
            }
        };

        // --- Data Fetching & Display Logic ---
        async function search(query) {
            if (query.length < 2) {
                lastSearchResultsData = [];
                showView('home');
                return;
            }
            try {
                const response = await fetch(`https://api.themoviedb.org/3/search/multi?query=${encodeURIComponent(query)}&include_adult=false`, tmdbOptions);
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const data = await response.json();
                lastSearchResultsData = data.results;
                showView('search');
            } catch (error) {
                console.error("Search failed:", error);
                searchResults.innerHTML = `<p class="col-span-full text-center text-[var(--md-sys-color-error)]">Failed to load search results.</p>`;
            }
        }

        const createPosterCard = (item) => {
            const year = item.release_date?.substring(0, 4) || item.first_air_date?.substring(0, 4) || 'N/A';
            const title = item.title || item.name;
            const type = item.media_type || (item.title ? 'movie' : 'tv');

            const pirateSearchQuery = encodeURIComponent(`${title} ${year}`);
            const pirateButton = type === 'movie' 
                ? `<a href="https://predb.me/?search=${pirateSearchQuery}&cats=movies" target="_blank" onclick="event.stopPropagation()" class="text-xl hover:scale-125 transition-transform" title="Search on predb.me">🏴‍☠️</a>` 
                : '';

            return `
                <div class="cursor-pointer group" data-id="${item.id}" data-type="${type}">
                    <div class="relative shadow-md rounded-xl overflow-hidden group-hover:shadow-xl transition-shadow duration-300 transform group-hover:scale-105 aspect-[2/3]">
                        <img src="https://image.tmdb.org/t/p/w500${item.poster_path}" alt="${title}" class="w-full h-full object-cover">
                    </div>
                    <div class="mt-2 pr-2">
                        <p class="text-sm font-medium">${title}</p>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-[var(--md-sys-color-on-surface-variant)]">${year}</p>
                            ${pirateButton}
                        </div>
                    </div>
                </div>`;
        }

        function displayResults(results) {
            searchResults.innerHTML = '';
            const validResults = results.filter(item => item.poster_path && (item.media_type === 'movie' || item.media_type === 'tv'));
            if (validResults.length === 0) {
                 searchResults.innerHTML = `<p class="col-span-full text-center text-[var(--md-sys-color-on-surface-variant)]">No results found.</p>`;
                 return;
            }
            searchResults.innerHTML = validResults.map(createPosterCard).join('');
        }

        async function getSeasons(tvId) {
            window.scrollTo(0, 0);
            try {
                const response = await fetch(`https://api.themoviedb.org/3/tv/${tvId}?language=en-US`, tmdbOptions);
                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                currentTvShowData = { id: tvId, name: data.name };
                seasonsTitle.textContent = data.name;
                seasonsGrid.innerHTML = data.seasons
                    .filter(season => season.poster_path)
                    .map(season => `
                        <div class="cursor-pointer group" data-season-tv-id="${tvId}" data-season-number="${season.season_number}">
                             <div class="relative shadow-md rounded-xl overflow-hidden group-hover:shadow-xl transition-shadow duration-300 transform group-hover:scale-105 aspect-[2/3]">
                                <img src="https://image.tmdb.org/t/p/w500${season.poster_path}" alt="${season.name}" class="w-full h-full object-cover">
                             </div>
                            <div class="mt-2">
                                <p class="text-sm font-medium">${season.name}</p>
                                <p class="text-sm text-[var(--md-sys-color-on-surface-variant)]">${season.air_date?.substring(0,4) || ''}</p>
                            </div>
                        </div>`
                    ).join('');
                showView('seasons');
            } catch (error) { console.error("Failed to get seasons:", error); }
        }
        
        function truncateToTwoSentences(text) {
            if (!text) return { short: "No summary available.", full: "No summary available.", needsExpanding: false };
            const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
            if (sentences.length <= 2) {
                return { short: text, full: text, needsExpanding: false };
            }
            const short = sentences.slice(0, 2).join(' ');
            return { short: short, full: text, needsExpanding: true };
        }

        async function getEpisodes(tvId, seasonNumber) {
            window.scrollTo(0, 0);
            try {
                const response = await fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNumber}?language=en-US`, tmdbOptions);
                 if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                episodesTitle.textContent = data.name;
                episodesList.innerHTML = '';
                data.episodes.forEach(episode => {
                    const airDate = episode.air_date ? new Date(episode.air_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
                    const { short: shortSummary, full: fullSummary, needsExpanding } = truncateToTwoSentences(episode.overview);

                    episodesList.innerHTML += `
                        <div class="episode-item bg-[var(--md-sys-color-surface-variant)] rounded-xl flex flex-col hover:bg-[var(--md-sys-color-surface-container-high)] transition-colors overflow-hidden">
                            <div class="cursor-pointer" data-play-tv-id="${tvId}" data-play-season="${seasonNumber}" data-play-episode="${episode.episode_number}">
                                <img src="${episode.still_path ? `https://image.tmdb.org/t/p/w500${episode.still_path}` : 'https://via.placeholder.com/500x281.png?text=No+Image'}" alt="${episode.name}" class="w-full h-auto object-cover aspect-video">
                            </div>
                            <div class="p-4 flex-grow flex flex-col">
                                <h4 class="font-bold text-base">${episode.episode_number}. ${episode.name}</h4>
                                <p class="text-sm text-[var(--md-sys-color-on-surface-variant)] mt-1">${airDate}</p>
                                <div class="mt-2 text-sm text-[var(--md-sys-color-on-surface-variant)] flex-grow">
                                    <p class="summary-text-short">${shortSummary}</p>
                                    <p class="summary-text-full hidden">${fullSummary}</p>
                                </div>
                                ${needsExpanding ? `
                                <button class="expand-summary-btn flex items-center text-[var(--md-sys-color-primary)] font-medium text-sm self-start mt-2" aria-expanded="false">
                                    <span class="material-icons">expand_more</span>
                                    <span class="ml-1 button-text">More</span>
                                </button>` : ''}
                            </div>
                        </div>`;
                });
                showView('episodes');
            } catch (error) { console.error("Failed to get episodes:", error); }
        }

        // --- Player & State Management ---
        function playVideo(type, id, season = null, episode = null) {
            let url;
            if (type === 'movie') {
                url = currentApiUrls.movie.replace('{tmdb}', id);
            } else if (type === 'tv' && season && episode) {
                url = currentApiUrls.tv
                    .replace('{tmdb}', id)
                    .replace('{season}', season)
                    .replace('{episode}', episode);
            } else {
                console.error("Invalid parameters for playVideo");
                return;
            }

            videoIframe.src = url;
            iframeModal.classList.remove('hidden');
            iframeModal.classList.add('flex');
        }
        
        function closeIframeModal() {
            iframeModal.classList.add('hidden');
            iframeModal.classList.remove('flex');
            videoIframe.src = ''; 
        }

        // --- UI & Navigation ---
        function showView(view) {
            searchResults.style.display = 'none';
            seasonsContainer.classList.add('hidden');
            episodesContainer.classList.add('hidden');
            navigationControls.innerHTML = '';

            const backButton = (id, text) => `<button id="${id}" class="bg-[var(--md-sys-color-secondary-container)] hover:opacity-90 text-[var(--md-sys-color-on-secondary-container)] font-bold py-2 px-4 rounded-full flex items-center transition-opacity"><span class="material-icons mr-2">arrow_back</span> ${text}</button>`;

            switch(view) {
                case 'home':
                    searchContainer.style.display = 'block';
                    searchResults.style.display = 'grid';
                     searchResults.innerHTML = `
                        <div class="group">
                            <a href="https://www.flicks.co.nz/now-playing/" target="_blank" rel="noopener noreferrer" class="cursor-pointer">
                                <div class="relative shadow-md rounded-xl overflow-hidden group-hover:shadow-xl transition-shadow duration-300 transform group-hover:scale-105 bg-[var(--md-sys-color-surface-variant)] flex items-center justify-center aspect-square p-4 text-6xl">
                                    <span>🎥</span>
                                </div>
                                <div class="mt-2 pr-2">
                                    <p class="text-md font-medium">Cinemas</p>
                                </div>
                            </a>
                        </div>
                        <div class="group">
                            <a href="https://www.flicks.co.nz/on-demand/" target="_blank" rel="noopener noreferrer" class="cursor-pointer">
                                <div class="relative shadow-md rounded-xl overflow-hidden group-hover:shadow-xl transition-shadow duration-300 transform group-hover:scale-105 bg-[var(--md-sys-color-surface-variant)] flex items-center justify-center aspect-square p-4 text-6xl">
                                    <span>📺</span>
                                </div>
                                <div class="mt-2 pr-2">
                                    <p class="text-md font-medium">Streaming</p>
                                </div>
                            </a>
                        </div>
                    `;
                    break;
                case 'search':
                    searchContainer.style.display = 'block';
                    searchResults.style.display = 'grid';
                    displayResults(lastSearchResultsData);
                    break;
                case 'seasons':
                    seasonsContainer.classList.remove('hidden');
                    navigationControls.innerHTML = backButton('back-to-search', 'Back to Search');
                    break;
                case 'episodes':
                    episodesContainer.classList.remove('hidden');
                    navigationControls.innerHTML = backButton('back-to-seasons', 'Back to Seasons');
                    break;
            }
        }
        
        async function loadPresets() {
            try {
                const response = await fetch(`presets.json?v=${Date.now()}`);
                if (!response.ok) throw new Error('Network response was not ok');
                API_PRESETS = await response.json();
                
                // Set default URLs from the first preset if not already in localStorage
                if (!localStorage.getItem('customApiMovieUrl') && API_PRESETS.length > 0) {
                    currentApiUrls.movie = API_PRESETS[0].movie_url;
                    currentApiUrls.tv = API_PRESETS[0].tv_url;
                    localStorage.setItem('customApiMovieUrl', currentApiUrls.movie);
                    localStorage.setItem('customApiTvUrl', currentApiUrls.tv);
                }
                
                // Populate settings modal inputs and generate buttons
                customApiMovieUrlInput.value = currentApiUrls.movie;
                customApiTvUrlInput.value = currentApiUrls.tv;
                generatePresetButtons();

            } catch (error) {
                console.error('Failed to load presets:', error);
                presetButtonsContainer.innerHTML = `<p class="text-sm text-[var(--md-sys-color-error)]">Could not load presets.</p>`;
            }
        }

        function generatePresetButtons() {
            presetButtonsContainer.innerHTML = '';
            API_PRESETS.forEach(preset => {
                const button = document.createElement('button');
                button.className = "preset-btn bg-[var(--md-sys-color-tertiary)] hover:opacity-90 text-[var(--md-sys-color-on-tertiary)] font-medium py-2 px-4 rounded-full transition-opacity";
                button.textContent = preset.name;
                button.addEventListener('click', () => {
                    customApiMovieUrlInput.value = preset.movie_url;
                    customApiTvUrlInput.value = preset.tv_url;
                });
                presetButtonsContainer.appendChild(button);
            });
        }

        // --- Event Listeners ---
        searchBar.addEventListener('keyup', (e) => search(e.target.value));

        document.addEventListener('click', (e) => {
            const expandBtn = e.target.closest('.expand-summary-btn');
            if (expandBtn) {
                const isExpanded = expandBtn.getAttribute('aria-expanded') === 'true';
                expandBtn.setAttribute('aria-expanded', !isExpanded);
                
                const container = expandBtn.closest('.episode-item');
                container.querySelector('.summary-text-short').classList.toggle('hidden');
                container.querySelector('.summary-text-full').classList.toggle('hidden');
                expandBtn.querySelector('.button-text').textContent = isExpanded ? 'More' : 'Less';
                return;
            }
            
            const movieCard = e.target.closest('[data-id][data-type]');
            if (movieCard) {
                const id = movieCard.dataset.id;
                const type = movieCard.dataset.type;
                type === 'movie' ? playVideo(type, id) : getSeasons(id);
                return;
            }

            const seasonCard = e.target.closest('[data-season-tv-id]');
            if (seasonCard) {
                getEpisodes(seasonCard.dataset.seasonTvId, seasonCard.dataset.seasonNumber);
                return;
            }

            const episodePlay = e.target.closest('[data-play-tv-id]');
            if (episodePlay) {
                playVideo('tv', episodePlay.dataset.playTvId, episodePlay.dataset.playSeason, episodePlay.dataset.playEpisode);
                return;
            }
            
            if (e.target.id === 'back-to-search') showView('search');
            if (e.target.id === 'back-to-seasons') showView('seasons');
        });
        
        iframeModal.addEventListener('click', (e) => {
            if (e.target === iframeModal) closeIframeModal();
        });
        closeIframeButton.addEventListener('click', closeIframeModal);
        
        // Settings listeners
        settingsButton.addEventListener('click', () => { settingsModal.style.display = 'flex' });
        closeSettings.addEventListener('click', () => { settingsModal.style.display = 'none' });
        saveSettings.addEventListener('click', () => {
            currentApiUrls.movie = customApiMovieUrlInput.value;
            currentApiUrls.tv = customApiTvUrlInput.value;
            localStorage.setItem('customApiMovieUrl', currentApiUrls.movie);
            localStorage.setItem('customApiTvUrl', currentApiUrls.tv);
            settingsModal.style.display = 'none';
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadPresets();
            showView('home');
        });
        self.addEventListener('install', event => {
  console.log('Service worker installing...');
  // You can add caching logic here
});

self.addEventListener('activate', event => {
  console.log('Service worker activating...');
});

// THIS IS THE CRUCIAL PART
self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request)
      .then(response => {
        return response || fetch(event.request);
      })
  );
});
    </script>
</body>
</html>
