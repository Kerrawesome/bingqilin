<!DOCTYPE html>
<html lang="en" class="bg-gray-100">      
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bing Qilin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles for the modal player overlay */
        #player-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            /* Smooth transition for the overlay */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #player-wrapper.visible {
            opacity: 1;
            visibility: visible;
        }

        /* Responsive container that maintains a 16:9 aspect ratio */
        #player-container {
            position: relative;
            width: 95vw;
            height: 53.4375vw; /* 16:9 aspect ratio (9/16 * 95) */
            max-width: 177.77vh; /* Prevents container from being wider than screen in portrait mode */
            max-height: 95vh;  /* Prevents container from being taller than screen in landscape mode */
            background-color: black;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        #player-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="container mx-auto p-4">

    <!-- Header and Search -->
    <header class="mb-8">
        <h1 class="text-4xl font-bold text-center mb-4 text-gray-800">Bing Qilin</h1>
        <div class="max-w-md mx-auto">
            <div class="relative">
                 <input type="text" id="searchInput" placeholder="Start typing to search..." class="bg-white border border-gray-300 text-gray-900 w-full px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>
    </header>

    <main id="mainContent">
        <!-- Back Button Navigation -->
        <div id="navigation-bar" class="hidden mb-4 space-x-2">
            <button id="backToSearchBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                &larr; Back to Search
            </button>
            <button id="backToSeasonsBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                &larr; Back to Seasons
            </button>
        </div>

        <!-- Results Grid -->
        <div id="resultsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
            <!-- Content will be injected here -->
        </div>
    </main>

    <!-- Player Wrapper -->
    <div id="player-wrapper">
        <div id="player-container">
            <iframe id="player" frameborder="0" allow="autoplay; fullscreen" sandbox="allow-same-origin allow-scripts" allowfullscreen></iframe>
        </div>
    </div>


    <script>
        const apiKey = "eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI0OTNiNWI3ODhlM2U0NDM4Y2Y2ZmY0ODI3NTJjN2Q2MSIsIm5iZiI6MTcxOTMxMjU2OC41NTY3MDEsInN1YiI6IjY2N2E5ZTczOTdkMDQ3YWNlNTNiNWU2MiIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.TRZDf_GmWas5rFhq-6wzT7RUJOCxvCUFf6hT-Jd9iIM";
        const searchInput = document.getElementById('searchInput');
        const playerWrapper = document.getElementById('player-wrapper');
        const player = document.getElementById('player');
        const resultsGrid = document.getElementById('resultsGrid');
        
        // Navigation Buttons
        const navigationBar = document.getElementById('navigation-bar');
        const backToSearchBtn = document.getElementById('backToSearchBtn');
        const backToSeasonsBtn = document.getElementById('backToSeasonsBtn');

        let lastSearchResults = [];
        let currentTvShow = null; // Store the TV show being browsed
        let debounceTimeout;

        const apiOptions = {
            method: 'GET',
            headers: {
                accept: 'application/json',
                Authorization: `Bearer ${apiKey}`
            }
        };

        // --- Event Listeners ---
        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                const query = searchInput.value.trim();
                performSearch(query);
            }, 500);
        });

        async function performSearch(query) {
            if (query) {
                const results = await searchTMDb(query);
                lastSearchResults = results;
                displaySearchResults(results);
            } else {
                lastSearchResults = [];
                displaySearchResults([]);
            }
            hidePlayer();
            updateNavigation();
        }

        playerWrapper.addEventListener('click', (e) => {
            if (e.target === playerWrapper) hidePlayer();
        });

        backToSearchBtn.addEventListener('click', () => {
            displaySearchResults(lastSearchResults);
            updateNavigation();
        });

        backToSeasonsBtn.addEventListener('click', () => {
            if (currentTvShow) {
                displaySeasons(currentTvShow);
                updateNavigation('seasons', currentTvShow);
            }
        });


        // --- API Fetching ---
        async function searchTMDb(query) {
            const url = `https://api.themoviedb.org/3/search/multi?query=${encodeURIComponent(query)}&include_adult=false&language=en-US&page=1`;
            const response = await fetch(url, apiOptions);
            const data = await response.json();
            return data.results;
        }

        async function getTvShowDetails(tvId) {
            const url = `https://api.themoviedb.org/3/tv/${tvId}?language=en-US`;
            const response = await fetch(url, apiOptions);
            return await response.json();
        }

        async function getTvSeasonDetails(tvId, seasonNumber) {
            const url = `https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNumber}?language=en-US`;
            const response = await fetch(url, apiOptions);
            return await response.json();
        }

        // --- Display Functions ---
        function displaySearchResults(results) {
            currentTvShow = null; // Clear TV show context
            resultsGrid.innerHTML = '';
            results.filter(item => item.poster_path && ['movie', 'tv'].includes(item.media_type)).forEach(item => {
                const year = item.release_date?.substring(0, 4) || item.first_air_date?.substring(0, 4) || '';
                const title = `${item.title || item.name} ${year ? `(${year})` : ''}`;
                const card = createCard(item.poster_path, title);
                card.addEventListener('click', () => handleItemClick(item));
                resultsGrid.appendChild(card);
            });
        }

        async function displaySeasons(tvShow) {
            updateNavigation('seasons', tvShow);
            resultsGrid.innerHTML = '';
            tvShow.seasons.forEach(season => {
                if (season.season_number > 0 && season.poster_path) {
                    const year = season.air_date ? `(${season.air_date.substring(0, 4)})` : '';
                    const title = `${season.name} ${year}`;
                    const card = createCard(season.poster_path, title);
                    card.addEventListener('click', async () => {
                        const seasonDetails = await getTvSeasonDetails(tvShow.id, season.season_number);
                        displayEpisodes(seasonDetails, tvShow);
                    });
                    resultsGrid.appendChild(card);
                }
            });
        }

        function displayEpisodes(seasonDetails, tvShow) {
            updateNavigation('episodes', tvShow);
            resultsGrid.innerHTML = '';
            seasonDetails.episodes.forEach(episode => {
                const episodeCard = document.createElement('div');
                episodeCard.className = 'bg-white border border-gray-200 rounded-lg overflow-hidden cursor-pointer transform hover:scale-105 transition-transform duration-300 shadow-md hover:shadow-xl';
                const airDate = episode.air_date ? new Date(episode.air_date).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }) : 'No date';
                episodeCard.innerHTML = `
                    <img src="${episode.still_path ? `https://image.tmdb.org/t/p/w500${episode.still_path}` : 'https://via.placeholder.com/500x281?text=No+Image'}" alt="${episode.name}" class="w-full h-auto object-cover" onerror="this.onerror=null;this.src='https://via.placeholder.com/500x281?text=No+Image';">
                    <div class="p-3">
                        <h3 class="font-bold text-sm">E${episode.episode_number}: ${episode.name}</h3>
                        <p class="text-xs text-gray-500 mb-2">${airDate}</p>
                        <p class="text-xs text-gray-600">${episode.overview}</p>
                    </div>
                `;
                episodeCard.addEventListener('click', () => playEpisode(tvShow.id, seasonDetails.season_number, episode.episode_number));
                resultsGrid.appendChild(episodeCard);
            });
        }

        // --- UI Logic ---
        function createCard(posterPath, title) {
            const card = document.createElement('div');
            card.className = 'bg-white border border-gray-200 rounded-lg overflow-hidden cursor-pointer transform hover:scale-105 transition-transform duration-300 shadow-md hover:shadow-xl';
            card.innerHTML = `
                <img src="https://image.tmdb.org/t/p/w500${posterPath}" alt="${title}" class="w-full h-auto">
                <div class="p-3">
                    <h3 class="font-bold text-sm">${title}</h3>
                </div>
            `;
            return card;
        }

        async function handleItemClick(item) {
            hidePlayer();
            if (item.media_type === 'movie') {
                playMovie(item.id);
            } else if (item.media_type === 'tv') {
                const tvDetails = await getTvShowDetails(item.id);
                displaySeasons(tvDetails);
            }
        }
        
        function updateNavigation(view = 'search', tvShow = null) {
            currentTvShow = tvShow; // Update context
            
            if (view === 'search') {
                navigationBar.classList.add('hidden');
            } else {
                navigationBar.classList.remove('hidden');
                backToSearchBtn.classList.remove('hidden');
                
                if (view === 'seasons') {
                    backToSeasonsBtn.classList.add('hidden');
                } else if (view === 'episodes') {
                    backToSeasonsBtn.classList.remove('hidden');
                }
            }
        }


        // --- Player ---
        function showPlayer() {
            playerWrapper.classList.add('visible');
            document.body.style.overflow = 'hidden';
        }

        function hidePlayer() {
            playerWrapper.classList.remove('visible');
            player.src = ''; // Stop the video
            document.body.style.overflow = '';
        }

        function playMovie(tmdbId) {
            player.src = `https://vidsrc.cc/v2/embed/movie/${tmdbId}`;
            showPlayer();
        }

        function playEpisode(tmdbId, seasonNumber, episodeNumber) {
            player.src = `https://vidsrc.cc/v2/embed/tv/${tmdbId}/${seasonNumber}/${episodeNumber}`;
            showPlayer();
        }
    </script>

</body>
</html>
